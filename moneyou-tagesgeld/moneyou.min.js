var MONEYOU_BLZ,ROWAWEB_KONTO_SYNC,ROWAWEB_KONTO_SYNC_JOB_KONTOAUSZUG,rowaweb,rowawebMoneyouKontoSync,rowawebMoneyouOverviewSync,rowawebMoneyouOverviewSyncJobKontoauszug;importPackage(Packages.de.willuhn.logging),importPackage(Packages.de.willuhn.jameica.system),importPackage(Packages.de.willuhn.jameica.hbci),importPackage(Packages.de.willuhn.jameica.hbci.rmi),importPackage(Packages.com.gargoylesoftware.htmlunit),importPackage(Packages.com.gargoylesoftware.htmlunit.html),importPackage(Packages.com.gargoylesoftware.htmlunit.util),MONEYOU_BLZ="50324040",ROWAWEB_KONTO_SYNC="rowawebMoneyouKontoSync",ROWAWEB_KONTO_SYNC_JOB_KONTOAUSZUG="rowawebMoneyouOverviewSyncJobKontoauszug",events.add("hibiscus.konto.sync",ROWAWEB_KONTO_SYNC),events.add("hibiscus.sync.function","rowawebMoneyouOverviewSync"),rowawebMoneyouOverviewSync=function(t,e){return t.getBLZ().equals(MONEYOU_BLZ)?e.equals(SynchronizeJobKontoauszug)?ROWAWEB_KONTO_SYNC_JOB_KONTOAUSZUG:null:null},rowawebMoneyouOverviewSyncJobKontoauszug=function(t,e){var o,n;return o=t.getKonto(),n=e.getProgressMonitor(),this[ROWAWEB_KONTO_SYNC](o,n)},rowawebMoneyouKontoSync=function(t,e){var o;return o=t.getBLZ().toString(),o.equals(MONEYOU_BLZ)?rowaweb.entryPoint(t,e):void 0},rowaweb={},rowaweb.entryPoint=function(t,e){var o,n,r;n=rowaweb.logger.init(e),r=new rowaweb.sync(t);try{r.synchronizeAccount()}catch(i){o=i,n.notice("Synchronisation fehlgeschlagen: "+o)}finally{try{r.finish()}catch(i){}}return!0},function(){var t;t=function(){function t(t){this.hiAccount=t,this.logger=rowaweb.logger.get(),this.site=new rowaweb.website}return t.prototype._debug=!1,t.prototype.balance=0,t.prototype.getSyncStartDate=function(){var t,e,o,n;return o=rowaweb.h.oneDay,e=this.hiAccount.getSaldoDatum(),n=new Date,t=new Date,!e||this._debug?(this.logger.info("Kein Saldendatum fuer das Konto gefunden, rufe die letzten 360 Tage ab."),n=new Date(t.getTime()-360*o)):(this.logger.debug("Letztes Abrufdatum: "+rowaweb.h.dateToString(e)),n=new Date(e.getTime()-14*o)),n},t.prototype.login=function(){var t,e;if(e=this._askPassword(),!e)return!1;try{this._tryLogin(e)}catch(o){return t=o,this.logger.notice("Login fehlgeschlagen: "+t),!1}return this.logger.progress(15),this.logger.notice("MoneYou-Login erfolgreich."),!0},t.prototype.close=function(){return this.logger.notice("Ausloggen..."),this.site.logout()},t.prototype.transactions=function(){var t,e,o,n,r,i,a,s,c,u,h,g;if(this._moveToDownloadSection(),this.balance=this._extractSaldoFromSelect(),i=rowaweb.h.dateToString(this.getSyncStartDate()),o=rowaweb.h.dateToString(new Date),this.logger.notice("Rufe Umsatzanzeige von "+i+" bis "+o+" auf."),this.site.fillIn("minDate",{"with":i,form:"DownloadMovementForm"}),this.site.fillIn("maxDate",{"with":o,form:"DownloadMovementForm"}),this.site.pressButton("btnNext"),r=this.site.currentPage().getFirstByXPath('//select[@name="accountNumber"]//option[@selected]').getValueAttribute(),!r.equals("50324040"+this.hiAccount.getKontonummer()))throw"Konnte Accountauswahl nicht uebernehmen. Abbruch.";if(a=this.site.currentPage().getFirstByXPath('//span[@id="totalMovements"]').asText(),a=Number(a),this.logger.notice(""+a+" Umsaetz(e) gefunden."),0===a)return[];for(e=this._downloadTransactions(),t=new rowaweb.csv(e,";"),this.logger.debug(t.rows),c=[],g=t.rows,u=0,h=g.length;h>u;u++)n=g[u],s=new rowaweb.transaction(n),s.isValid()&&c.push(s);return c},t.prototype._askPassword=function(){var t,e;try{return e=Application.getCallback().askPassword("Bitte geben Sie das Passwort zum MoneYou-Konto "+this.hiAccount.getKontonummer()+" ein:")}catch(o){return t=o,this.logger.notice("Synchronisation durch Benutzer abgebrochen."),void 0}},t.prototype._tryLogin=function(t){var e;this.site.get("/thc/policyenforcer/pages/loginB2C.jsf"),this.site.fillIn("j_username_pwd",{"with":this.hiAccount.getKundennummer(),form:"loginForm"}),this.site.fillIn("j_password_pwd",{"with":t,form:"loginForm"}),this.site.pressButton("btnNext"),e=this.site.currentPage();try{return e.getFormByName("arcidHeaderBlockForm")}catch(o){throw this.logger.debug(this.site.currentPage().asXml()),"Login fehlgeschlagen. MoneYou-Loginbestaetigung nicht erkannt."}},t.prototype._downloadTransactions=function(){var t;return this.logger.notice("Download startet..."),this.site.pressButton("fileDownload:0:"),t=this.site.currentPage().getWebResponse().getContentAsString(),this.site.back(),t},t.prototype._extractSaldoFromSelect=function(){var t,e,o;if(o=this.site.currentPage().getFirstByXPath('//select[@name="accountNumber"]//option[@selected]').asText(),e=o.match(/([0-9.,]+)\s*EUR$/),null!=e?e.length:void 0)return t=e[1],parseFloat(t.replace(/\./g,"").replace(/,/,"."));throw this.logger.debug(o),"Saldo kann nicht ermittelt werden."},t.prototype._moveToDownloadSection=function(){var t;this.site.clickLeftNav("MNU:0:0:1"),this.site.pressButton("btnNext"),this.site.pressButton("downloadStatementsLinkButton");try{this.site.currentPage().getFormByName("DownloadMovementForm")}catch(e){throw t=e,this.logger.debug(this.site.currentPage().asXml()),"Kontouebersicht kann nicht geladen werden. Formular nicht gefunden: "+t}return this.site.selectOption("accountNumber",{form:"DownloadMovementForm",value:"50324040"+this.hiAccount.getKontonummer()}),this.logger.progress(22)},t}(),rowaweb.account=t}.call(this),function(){var t;t=function(){function t(t,e){this.rows=this._parse(t,e)}return t.prototype._parse=function(t,e){var o,n,r,i,a;for(e=e||",",r=new RegExp("(\\"+e+"|\\r?\\n|\\r|^)"+'(?:"([^"]*(?:""[^"]*)*)"|'+'([^"\\'+e+"\\r\\n]*))","gi"),o=[[]],n=null;n=r.exec(t);)i=n[1],i.length&&!i.equals(e)&&o.push([]),a=n[2]?n[2].replace(new RegExp('""',"g"),'"'):n[3],o[o.length-1].push(a);return o},t}(),rowaweb.csv=t}.call(this),function(){var t;t=function(){function t(){}return t.prototype.accountNumberToMYFormat=function(t){var e,o;return o=t.toString(),e=o.match(/(\d{4})(\d{4})(\d{2})/),e.splice(0,1),e.join(" ")},t.prototype.dateToString=function(t){var e,o,n;return e=String(t.getDate()),e=10>e?"0"+e:e,o=String(t.getMonth()+1),o=10>o?"0"+o:o,n=t.getYear()+1900,""+e+"."+o+"."+n},t.prototype.oneDay=864e5,t.prototype.parseDate=function(t){var e;return e=t.split("."),new Date(e[2],e[1]-1,e[0])},t.prototype.parseCurrency=function(t){return parseFloat(t.replace(/\./g,"").replace(/\,/,"."))},t.prototype.trim=function(t){return t.replace(/^\s+|\s+$/g,"")},t}(),rowaweb.h=new t}.call(this),function(){var t,e;e=function(){function t(t){this.monitor=t}return t.prototype.progress=function(t){return this.monitor.setPercentComplete(t)},t.prototype.notice=function(t){return this.monitor.log(t),Logger.info(t)},t.prototype.info=function(t){return Logger.info(t)},t.prototype.debug=function(t){return Logger.debug(t)},t}(),t=function(){function t(){}var o;return o=null,t.init=function(t){return o=new e(t)},t.get=function(){return o},t}(),rowaweb.logger=t}.call(this),function(){var t;t=function(){function t(t){this.hiAccount=t,this.account=new rowaweb.account(t),this.logger=rowaweb.logger.get()}return t.prototype.synchronizeAccount=function(){var t,e;return this.logger.progress(5),this.account.login()?(e=this.account.transactions(),e.length&&this.account.balance&&(this.hiAccount.setSaldo(this.account.balance),this.hiAccount.store()),this.logger.progress(30),e=this._storeBalancesInTransactions(e),t=this._storeTransactions(e),!0):(this.logger.progress(100),void 0)},t.prototype.finish=function(){var t;return null!=(t=this.account)&&t.close(),!0},t.prototype._storeTransactions=function(t){var e,o,n,r,i,a,s;for(e=Application.getServiceFactory().lookup(HBCI,"database"),r=this._storedTransactions(),n=a=0,s=t.length;s>a;n=++a)i=t[n],this.logger.progress(30+69/t.length*n),o=e.createObject(Umsatz,null),o.setKonto(this.hiAccount),o=i.prepareHiTransaction(o),(null!=r?r.contains(o):void 0)?this.logger.info("Transaktion bereits vorhanden: "+i+"."):(this.logger.info("Speichere Transaktion "+i+"."),o.store());return!0},t.prototype._storeBalancesInTransactions=function(t){var e,o,n,r,i;for(e=this.hiAccount.getSaldo(),i=t.slice(0).reverse(),n=0,r=i.length;r>n;n++)o=i[n],o.balance=e,e-=o.amount,e=Math.round(100*e)/100;return t},t.prototype._storedTransactions=function(){var t,e;return e=this.account.getSyncStartDate(),t=(new Date-e)/rowaweb.h.oneDay,this.hiAccount.getUmsaetze(t+7)},t}(),rowaweb.sync=t}.call(this),function(){var t;t=function(){function t(t){return this.cols=t,this.logger=rowaweb.logger.get(),this.cols[0].equals("Kontonummer:")||this.cols[0].equals("Operationsnummer")||this.cols.length<11?(this.logger.debug("Ueberspringe Zeile: "+this.cols),void 0):(this.id=this.cols[0],this.documentDate=rowaweb.h.parseDate(this.cols[1]),this.amount=rowaweb.h.parseCurrency(this.cols[3]),this.valutaDate=rowaweb.h.parseDate(this.cols[5]),this.primanota=this.cols[10],this.contraAccountName=this.cols[7],this.contraAccountName.length<2&&(this.comment=this.cols[2]),this._assignContraAccount(t[6]),this._splitPurpose([this.cols[8],this.cols[9]].join(" ")),void 0)}return t.prototype.id=void 0,t.prototype.documentDate=void 0,t.prototype.comment=void 0,t.prototype.amount=void 0,t.prototype.valutaDate=void 0,t.prototype.contraAccountName=void 0,t.prototype.contraAccountNumber=void 0,t.prototype.contraAccountAccountNumber=void 0,t.prototype.purpose1=void 0,t.prototype.purpose2=void 0,t.prototype.primanota=void 0,t.prototype.balance=void 0,t.prototype._assignContraAccount=function(t){var e;return(null!=t?t.length:void 0)&&(e=t.split(" "),2===e.length)?(this.contraAccountNumber=e[1],this.contraAccountAccountNumber=e[0]):void 0},t.prototype._splitPurpose=function(t){return t||(t=""),this.purpose1=t.substr(0,35),t.length>35&&(this.purpose2=t.substr(35,35)),!0},t.prototype.isValid=function(){var t,e;try{return(typeof this.amount).equals("number")&&this.contraAccountNumber.length>2&&this.contraAccountAccountNumber.length>2&&(null!=(t=this.documentDate)?t.getDay():void 0),null!=(e=this.valutaDate)?e.getDay():void 0}catch(o){return!1}},t.prototype.toString=function(){return"<Transaction documentDate="+this.documentDate+" "+(" amount="+this.amount+" contra="+this.contraAccountName+" balance="+this.balance)+(" primanota="+this.primanota+" comment="+this.comment+" @purpose1="+this.purpose1)+">"},t.prototype.prepareHiTransaction=function(t){var e;return t.setDatum(this.documentDate),t.setValuta(this.valutaDate),t.setBetrag(this.amount),t.setSaldo(this.balance),t.setPrimanota(this.primanota),t.setGegenkontoName(this.contraAccountName),(null!=(e=this.contraAccountNumber)?e.length:void 0)&&(t.setGegenkontoNummer(this.contraAccountNumber),t.setGegenkontoBLZ(this.contraAccountAccountNumber)),t.setKommentar(this.comment),t.setZweck(this.purpose1),t.setZweck2(this.purpose2),t},t}(),rowaweb.transaction=t}.call(this),function(){var t;t=function(){function t(){this.logger=rowaweb.logger.get(),this._setupClient()}return t.prototype.baseUrl="https://secure.moneyou.de",t.prototype.page=void 0,t.prototype._setupClient=function(){var t;return this.client=new WebClient,t=this.client.getOptions(),t.setUseInsecureSSL(!1),t.setRedirectEnabled(!0),t.setJavaScriptEnabled(!0),t.setThrowExceptionOnScriptError(!1),t.setThrowExceptionOnFailingStatusCode(!1),t.setCssEnabled(!1),this.client},t.prototype.hasText=function(t){var e;return e=this.page.asXml().toString(),e.match(new RegExp(t,"g"))},t.prototype.back=function(){return this.client.getWebWindows().get(0).getHistory().back(),this.page=this.client.getWebWindows().get(0).getEnclosedPage()},t.prototype.logout=function(){var t;return t=this.page.getFirstByXPath("//a[@class='logOff']"),this.page=t.click(),this.hasText("erfolgreich abgemeldet")},t.prototype.get=function(t){var e;return e=""+this.baseUrl+t,this.page=this.client.getPage(e)},t.prototype._formForOptions=function(t){var e;return e=t.form,(typeof e).equals("string")&&(e=this.page.getFormByName(e)),e},t.prototype.fillIn=function(t,e){var o,n;return n=e["with"],o=this._formForOptions(e),o.getInputByName(t).setValueAttribute(n)},t.prototype.selectOption=function(t,e){var o,n,r,i,a,s,c,u,h;for(o=!1,r=this._formForOptions(e),c=null!=e.value,n=r.getSelectByName(t),u=n.getOptions(),a=u.size()-1,i=h=0;a>=0?a>=h:h>=a;i=a>=0?++h:--h){if(s=u.get(i),!c)throw"No implemented";s.getValueAttribute().equals(e.value)&&(s.setSelected(!0),o=!0)}if(!o)throw this.logger.debug(this.page.asXml()),"Option in Feld "+t+" nicht gefunden.";return!0},t.prototype.pressButton=function(t){return this.page=this.page.getElementByName(t).click()},t.prototype.clickLeftNav=function(t){var e;return e=this.page.getFirstByXPath("//a[@id='"+t+"']"),this.page=e.click()},t.prototype.currentPage=function(){return this.page},t}(),rowaweb.website=t}.call(this);